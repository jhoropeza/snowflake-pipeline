name: ❄️ Despliegue de Notebooks y Fetch

on:
  push:
    branches:
      - '*' 

  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'Selecciona el esquema de destino (DEV o MAIN)'
        required: true
        type: choice
        options: 
          - DEV
          - MAIN
          
      source_branch:
        description: 'Rama Git de donde se extraerá el código (opcional: deja vacío para usar la rama seleccionada arriba)'
        required: false
        type: string
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python packages
        run: pip install -r requirements.txt
        
      - name: Deploy notebooks and fetch
        env:
          ENV_TARGET: ${{ github.event_name == 'push' && (github.ref_name == 'main' && 'MAIN' || 'DEV') || github.event.inputs.deployment_target }}
          SOURCE_BRANCH_NAME: ${{ github.event_name == 'push' && github.ref_name || (github.event.inputs.source_branch || (github.event.inputs.deployment_target | lower)) }}
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
          
        run: |
          # 2. Convertir a minúsculas para usar en la URL de la rama (e.g., MAIN -> main)
          BRANCH_NAME=$(echo $ENV_TARGET | tr '[:upper:]' '[:lower:]')
          
          # 3. CREAR ESQUEMA DINÁMICO: Crea el esquema de destino (ej: MAIN_SCHEMA) si no existe.
          # Esto resuelve el error 002003.
          TARGET_SCHEMA_NAME=$(echo $ENV_TARGET)_SCHEMA
          echo "Creando o asegurando la existencia del esquema: $TARGET_SCHEMA_NAME en la BD: $SNOWFLAKE_DATABASE"
          snow sql -q "CREATE SCHEMA IF NOT EXISTS $TARGET_SCHEMA_NAME;" \
            --temporary-connection --account $SNOWFLAKE_ACCOUNT --user $SNOWFLAKE_USER \
            --role $SNOWFLAKE_ROLE --warehouse $SNOWFLAKE_WAREHOUSE --database $SNOWFLAKE_DATABASE

          # 4. Primer comando: Fetch de la rama seleccionada
          snow sql -q "ALTER GIT REPOSITORY DEMO_GIT_REPO_V2 FETCH" \
            --temporary-connection --account $SNOWFLAKE_ACCOUNT --user $SNOWFLAKE_USER \
            --role $SNOWFLAKE_ROLE --warehouse $SNOWFLAKE_WAREHOUSE --database $SNOWFLAKE_DATABASE --schema $SNOWFLAKE_SCHEMA

          # 5. Segundo comando: Ejecutar el script SQL usando las variables dinámicas
          snow sql -q "EXECUTE IMMEDIATE FROM @DEMO_GIT_REPO_V2/branches/$BRANCH_NAME/script_to_deploy_notebooks/deploy_notebooks.sql USING (env => '$ENV_TARGET', branch => '$BRANCH_NAME')" \
            --temporary-connection --account $SNOWFLAKE_ACCOUNT --user $SNOWFLAKE_USER \
            --role $SNOWFLAKE_ROLE --warehouse $SNOWFLAKE_WAREHOUSE --database $SNOWFLAKE_DATABASE --schema $SNOWFLAKE_SCHEMA
